## 컴퓨터 시스템의 동작 원리

컴퓨터 내부 장치 : CPU, 메모리

컴퓨터 외부 장치 : 키보드, 모니터, 마우스 등등



컴퓨터 내의 각 하드웨어 장치에는 컨트롤러가 존재한다. 컨트롤러는 일종의 작은 CPU로서, 컴퓨터 전체에 CPU라는 중앙 처리 장치가 있듯이 컨트롤러는 각 하드웨어 장치마다 존재하면서 이들을 제어하는 작은 CPU라 할 수 있다.



#### CPU와 I/O 연산

입출력 장치들의 I/O 연산은 I/O 컨트롤러가 담당하고, 컴퓨터 내에서 수행되는 연산은 Main CPU가 담당한다. 이때 입출력 장치와 CPU는 동시 수행이 가능하다. 또한, 각 장치에는 이를 제어하기 위해 설치된 장치 컨트롤러에는 장치로부터 들어오고 나가는 데이터를 임시로 저장하기 위한 작은 메모리인 **로컬 버퍼(Local buffer)**를 가지고 있다.

![img](https://k.kakaocdn.net/dn/nQMPr/btqvibzgA7P/K5kiif4k0biN5AhGt8BG9K/img.png)

과정

1. 프로세스에서 외부 입출력에 대한 요청 발생.
2. 컨트롤러에 의해서 외부 장치로의 입출력을 제어.
3. 외부 장치와 입출력 발생.
4. 로컬 버퍼에 데이터를 임시로 저장.
5. **컨트롤러에 의해 인터럽트 발생.**
6. CPU는 컨트롤러로부터 발생한 인터럽트에 대해 인터럽트 라인을 통해 확인
7. 로컬 버퍼의 데이터는 메모리에 상주한 프로세스의 영역에 이동 후 저장

- 인터럽트 : 컨트롤러들이 CPU의 서비스가 필요할 때, 이를 통보하는 방법
- 인터럽트는 키보드 입력 혹은 디스크에서 데이터를 다 읽어왔다는 등의 이벤트를 CPU에게 알려줄 필요가 있을 경우, 컨트롤러가 발생시키는 것.



#### 인터럽트의 일반적 기능

- 인터럽트 처리 루틴 : 운영 체제 커널 내에 존재하는 인터럽트 처리 루틴은 다양한 인터럽트에 대해 각각 처리해야 할 업무들을 정의하고 있다.
- 인터럽트 : 하드웨어 인터럽트, 소프트웨어 인터럽트
  - CPU의 서비스가 필요한 경우, CPU 옆에 있는 인터럽트 라인에 신호를 보내어 인터럽트가 발생했음을 알리는 것은 동일하다.
  - 하드웨어 인터럽트 : 컨트롤러 등 하드웨어 장치가 CPU의 인터럽트 라인을 세팅
  - 소프트웨어 인터럽트 : 소프트웨어가 그 일을 수행.
- 인터럽트 처리 루틴은 인터럽트 벡터(interrupt vector)와 인터럽트 서비스 루틴(interrupt service routine)을 담고 있다.
- **인터럽트 벡터** : 인터럽트 종류마다 번호를 부여해서 번호에 따라 처리해야 할 코드가 위치한 부분을 포인터로 가리키고 있는 자료구조.
- **인터럽트 서비스 루틴** : 인터럽트 벡터를 통해 확인한 실제로 작동해야 하는 코드 내용



위의 6번 컨트롤러에 의한 인터럽트 발생시 CPU는 인터럽트 라인의 확인을 통해 인터럽트를 확인하고 OS 영역내의 커널에 있는 인터럽트 처리 루틴을 통해 그에 알맞는 대응을 한다.



#### 인터럽트 핸들링

인터럽트가 발생한 경우에 처리해야 할 일의 절차를 의미한다.

프로그램 A 수행 -> 인터럽트 발생 -> A의 현재 상태 저장 -> 인터럽트 처리

- 현재 상태란 현재 CPU가 수행 중이던 메모리 주소를 포함해 몇 가지 부가적인 정보들을 의미한다.

운영체제 커널 영역에는 현재 시스템 내에서 수행되는 프로그램들을 관리하기 위한 자료 구조인 프로세스 제어 블록(PCB : Process Control Block)을 두고 있다. **인터럽트가 발생했을 때, 프로그램의 어느 부분이 수행되던 중이었는지를 저장하기 위한 자료구조로 사용된다.** 저장되는내용으로는 현재 수행중이던 메모리 주소, 레지스터 값, 하드웨어 상태 등이 있다. 인터럽트 수행이 끝나면 저장된 값을 다시 CPU 상에 복원해 진행 중이던 명령을 계속 수행할 수 있다.



프로그램 내부의 함수 호출시 그 복원 지점에 대한 정보는 각 프로그램의 주소 공간 중 스택 부분에 저장된다.



프로그램 A가 수행중에 인터럽트가 발생하면 현재까지 수행된 지점을 프로세스 제어 블록(PCB)에 저장하고, 인터럽트 처리 루틴으로 와서 커널 코드를 수행하게 되며, 이때 이루어지는 함수 호출은 프로세스 A의 커널 스택을 사용하게 된다. 인터럽트 처리가 끝마쳐진 후에는 PCB에 저장된 주소로 되돌아가서 중지된 작업의 나머지 부분을 수행하게 된다.



인터럽트 처리 중에는 다른 인터럽트의 발생을 허용하지 않는다. 이유는 인터럽트 처리 중에 다른 입터러트를 처리하게 되면 데이터의 일관성이 유지되지 않는 경우가 발생하기 때문이다. 인터럽트를 처리하는 중 운영 체제 커널에 정의된 데이터를 변경하고 있는데 다른 인터럽트가 발생해 앞선 인터럽트에서 변경중이던 데이터를 또다시 변경하게 되면 두 인터럽트에 의해 데이터가 원래 의도하지 않았던 결과 값으로 변경될 수 있기 때문이다.



Ex)

A라는 프로그램이 수행되다가 인터럽트가 발생하면 인터럽트 처리 루틴 내에서의 함수 호출 및 리턴 정보는 A의 커널 스택에 저장하게 된다. 요청된 인터럽트에 대한 처리를 수행하던 중에 또 다른 인터럽트가 발생하면, 이 인터럽트 처리 중 발생하는 함수 호출 및 리턴과 관련된 정보를 A의 커널 스택에 또 다시 저장하게 된다. 스택에서 함수를 호출한 후 호출된 함수가 또 다른 함수를 호출할 때와 마찬가지로 중요도가 높은 인터럽트를 먼저 처리하고 난후 CPU를 점령당한 이전의 인터럽트로 돌아가서 하던 작업을 처리하게 된다.



[소프트웨어 인터럽트]

통상적으로 인터럽트는 하드웨어 인터럽트를 의미하며, 소프트웨어 인터럽트는 트랩(trap)이라는 용어로 주로 불린다.

- Ex) 예외 상황(exception), 시스템 콜(System Call)
- 예외 상황이란 프로세스가 0으로 나누는 연산 등 불가능한 작업을 시도하거나 자신의 메모리 영역 바깥을 접근하려는 시도를 할 때 이에 대한 처리를 위해 발생시키는 인터럽트.
- 시스템 콜이란 프로그램이 자신이 작성하지 않은 코드를 운영 체제로부터 서비스 받기 위해 발생시키는 것.



> 일반적인 함수 호출 vs 시스템 콜
>
> - 일반적인 함수 호출 : 자신이 작성한 함수 또는 라이브러리에 정의된 함수를 호출하는 것.
> - 시스템 콜 : 운영체제에 정의된 함수를 호출하는 것. 이는 일종의 인터럽트 매커니즘으로 동작한다.
>   - printf() 함수를 호출하면 라이브러리 함수인 printf()는 일종의 인터럽트 매커니즘인 write() 시스템 콜을 통해 커널에 입출력 명령을 대신 수행하도록 요청한다. 그러면 운영체제는 해당하는 인터럽트를 처리하기 위한 루틴을 찾고 화면에 출력하라는 요청에 따라 정보를 화면에 출력한다.



#### 입출력 구조































































